name: Claude Code Agent

on:
  issues:
    types: [labeled]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

concurrency:
  group: claude-agent-${{ github.event.issue.number || github.event.pull_request.number }}
  cancel-in-progress: false

jobs:
  # ────────────────────────────────────────────────────────────
  # JOB 1: Agent — runs the Claude Code agent on the task
  # ────────────────────────────────────────────────────────────
  agent:
    name: Run Claude Agent
    runs-on: ubuntu-latest
    timeout-minutes: 20

    if: |
      (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'agent-task')) ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude'))

    outputs:
      outcome:     ${{ steps.agent.outcome }}
      pr_number:   ${{ steps.find-pr.outputs.pr_number }}
      pr_title:    ${{ steps.find-pr.outputs.pr_title }}
      pr_body:     ${{ steps.find-pr.outputs.pr_body }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      # Write task context to TASK.md so the agent can read it
      # (agent cannot use Bash to read env vars — file is the safe approach)
      - name: Write task context to TASK.md
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE:  ${{ github.event.issue.title }}
          ISSUE_BODY:   ${{ github.event.issue.body }}
          ISSUE_LABELS: ${{ join(github.event.issue.labels.*.name, ', ') }}
        run: |
          cat > TASK.md << TASKEOF
          # Current Task

          **Issue:** #${ISSUE_NUMBER}
          **Title:** ${ISSUE_TITLE}
          **Labels:** ${ISSUE_LABELS}

          ## Description

          ${ISSUE_BODY}
          TASKEOF

      # ── Core agent step ──────────────────────────────────────
      - name: Run Claude Code Agent
        id: agent
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_MODEL: claude-haiku-4-5
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          label_trigger: "agent-task"
          claude_args: "--max-turns 30"
          allowed_tools: "Edit,Write,Bash,GitCreateBranch,GitCommit,GitPush,CreatePullRequest,ReadFile,ListFiles,Glob"
          prompt: |
            You are the Flywheel autonomous coding agent.

            Your task is described in TASK.md at the root of the repo. Read it first.

            Then follow these steps in order:
            1. Read TASK.md — this contains the issue title, labels, and full description
            2. Read .claude/skillbank-index.md — decide which skills apply
            3. Load ALL files from .claude/skills/general/
            4. Load task-specific skill files from .claude/skills/task-specific/ matching the labels
            5. Read CLAUDE.md for general agent guidelines
            6. Read project-map.md to understand the codebase structure
            7. Implement the task described in TASK.md
            8. Create a PR — include in the description which skill files you loaded

            Rules:
            - Keep index.html self-contained (single file, no build step)
            - Never commit TASK.md — it is a temporary file for this run only
            - If you hit an obstacle, document it clearly in the PR description

      # ── Find the PR the agent created ───────────────────────
      - name: Find PR created by agent
        id: find-pr
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sleep 5
          PR_DATA=$(gh pr list \
            --state open \
            --author "github-actions[bot]" \
            --limit 1 \
            --json number,title,body \
            2>/dev/null || echo "[]")

          PR_NUMBER=$(echo "$PR_DATA" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d[0]['number'] if d else '')" 2>/dev/null || echo "")
          PR_TITLE=$(echo  "$PR_DATA" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d[0]['title']  if d else '')" 2>/dev/null || echo "")
          PR_BODY=$(echo   "$PR_DATA" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d[0]['body']   if d else '')" 2>/dev/null || echo "")

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "pr_title=$PR_TITLE"   >> $GITHUB_OUTPUT
          echo "pr_body=${PR_BODY:0:2000}" >> $GITHUB_OUTPUT
          echo "Found PR: #$PR_NUMBER — $PR_TITLE"

  # ────────────────────────────────────────────────────────────
  # JOB 2: Distiller — extracts skill/lesson after agent run
  # ────────────────────────────────────────────────────────────
  distiller:
    name: Distill Skill (SkillRL)
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: agent
    if: always()

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 2
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Anthropic SDK
        run: pip install anthropic --quiet

      - name: Run distiller
        id: distill
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          TASK_TITLE:        ${{ github.event.issue.title }}
          TASK_DESCRIPTION:  ${{ github.event.issue.body }}
          TASK_LABELS:       ${{ join(github.event.issue.labels.*.name, ',') }}
          TASK_OUTCOME:      ${{ needs.agent.outputs.outcome }}
          PR_NUMBER:         ${{ needs.agent.outputs.pr_number }}
          PR_TITLE:          ${{ needs.agent.outputs.pr_title }}
          PR_BODY:           ${{ needs.agent.outputs.pr_body }}
        run: |
          python3 .github/scripts/distill.py

      - name: Commit skills to main
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name  "flywheel-distiller[bot]"
          git config user.email "flywheel-distiller@users.noreply.github.com"

          git add .claude/skills/ lessons.md .claude/skillbank-index.md 2>/dev/null || true

          if git diff --staged --quiet; then
            echo "No skill changes to commit."
          else
            OUTCOME="${{ needs.agent.outputs.outcome }}"
            ISSUE_TITLE="${{ github.event.issue.title }}"
            git commit -m "distill($OUTCOME): ${ISSUE_TITLE:0:60}"
            git pull --rebase origin main
            git push origin main
            echo "✅ Skills committed to main"
          fi
