name: Claude Code Agent

on:
  issue_comment:
    types: [created]
  issues:
    types: [labeled]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write
  actions: read

concurrency:
  group: claude-agent
  cancel-in-progress: false

jobs:
  claude:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - uses: anthropics/claude-code-action@v1
        id: claude
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          label_trigger: "agent-task"
          claude_args: "--max-turns 30"
          additional_permissions: |
            actions: read
          settings: |
            {
              "permissions": {
                "allow": [
                  "Bash(gh issue view:*)",
                  "Bash(gh issue list:*)",
                  "Bash(gh pr create:*)",
                  "Bash(gh pr view:*)",
                  "Bash(git add:*)",
                  "Bash(git checkout:*)",
                  "Bash(git commit:*)",
                  "Bash(git push:*)",
                  "Bash(git branch:*)",
                  "Bash(git diff:*)",
                  "Bash(git log:*)",
                  "Bash(git fetch:*)",
                  "Bash(git pull:*)",
                  "Bash(git status)",
                  "Read",
                  "Write",
                  "Edit",
                  "MultiEdit",
                  "Glob",
                  "Grep",
                  "TodoRead",
                  "TodoWrite",
                  "mcp__github_workflow_runs__*"
                ]
              }
            }
          prompt: |
            You are the Flywheel autonomous coding agent.

            ## Mandatory first steps — always follow this order:
            1. Read the triggering issue: use `gh issue view <number> --json title,body`
            2. Read project-map.md ENTIRELY — this is your compressed understanding of the codebase
            3. Read .claude/skills/ for any procedures relevant to your task
            4. Read ONLY the relevant code sections mentioned in project-map.md that match the task
            5. If you need more context, ask yourself "which 50-200 line region do I need?" and read only that range
            6. Never read the full index.html unless the change touches >40% of the file

            ## Implementation rules:
            - Implement the requested changes — do NOT just review or audit the codebase
            - Follow the guidelines in CLAUDE.md
            - Follow procedures in .claude/skills/ when they match your task
            - Keep index.html self-contained (single file, no build step)
            - Commit to a new branch with a conventional commit message
            - Create a PR referencing the issue number
            - ALWAYS update project-map.md line ranges after editing index.html

            ## Learning rules:
            - After completing a task, append a 1-2 line lesson to .claude/skills/lessons.md
            - Format: YYYY-MM-DD #issue: what you learned
            - Read .claude/skills/lessons.md before starting — avoid repeating past mistakes

            ## Efficiency rules:
            - Solve the task in as few tool calls as possible
            - Plan first, then execute — avoid exploratory loops
            - If the issue provides line numbers, go directly to those lines

            ## Self-diagnosis:
            - You have access to workflow run logs via mcp__github_workflow_runs tools
            - If a previous run failed, you can inspect logs to understand why
            - Use this to avoid repeating the same failure

      - name: Post cost report
        if: always() && steps.claude.outputs.execution_file
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          EXEC_FILE="${{ steps.claude.outputs.execution_file }}"
          if [ ! -f "$EXEC_FILE" ]; then exit 0; fi

          # Extract cost and duration from execution data
          COST=$(python3 -c "
          import json, sys
          data = json.load(open('$EXEC_FILE'))
          # Handle both array and object formats
          items = data if isinstance(data, list) else [data]
          for item in reversed(items):
            t = item.get('type', '')
            if t in ('result', 'final_result'):
              d = item.get('data', item)
              cost = d.get('total_cost_usd', d.get('cost_usd', 0))
              dur = d.get('duration_ms', 0) / 1000
              turns = d.get('num_turns', 0)
              print(f'Cost: \${cost:.4f} | Duration: {dur:.1f}s | Turns: {turns}')
              sys.exit(0)
            # Also check top-level fields (non-nested format)
            if 'total_cost_usd' in item:
              cost = item['total_cost_usd']
              dur = item.get('duration_ms', 0) / 1000
              turns = item.get('num_turns', 0)
              print(f'Cost: \${cost:.4f} | Duration: {dur:.1f}s | Turns: {turns}')
              sys.exit(0)
          " 2>/dev/null || echo "")

          if [ -z "$COST" ]; then exit 0; fi

          # Find the issue number from the event
          ISSUE_NUM=$(jq -r '.issue.number // .pull_request.number // empty' "$GITHUB_EVENT_PATH")
          if [ -z "$ISSUE_NUM" ]; then exit 0; fi

          gh issue comment "$ISSUE_NUM" --repo "$GITHUB_REPOSITORY" --body "**Agent Run Report** — $COST"
