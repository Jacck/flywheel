name: Claude Code Agent

on:
  issues:
    types: [labeled]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

concurrency:
  group: claude-agent-${{ github.event.issue.number || github.event.pull_request.number }}
  cancel-in-progress: false

jobs:
  # ────────────────────────────────────────────────────────────
  # JOB 1: Agent — runs the Claude Code agent on the task
  # ────────────────────────────────────────────────────────────
  agent:
    name: Run Claude Agent
    runs-on: ubuntu-latest
    timeout-minutes: 20

    # Only trigger on agent-task label or @claude mention in comments
    if: |
      (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'agent-task')) ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude'))

    outputs:
      outcome:     ${{ steps.agent.outcome }}
      pr_number:   ${{ steps.find-pr.outputs.pr_number }}
      pr_title:    ${{ steps.find-pr.outputs.pr_title }}
      pr_body:     ${{ steps.find-pr.outputs.pr_body }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      # ── Core agent step ──────────────────────────────────────
      - name: Run Claude Code Agent
        id: agent
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          label_trigger: "agent-task"
          claude_args: "--max-turns 30 --model claude-sonnet-4-6"
          prompt: |
            You are the Flywheel autonomous coding agent.

            BEFORE starting any task:
            1. Read .claude/skillbank-index.md to see available skills
            2. Load skills relevant to this task from .claude/skills/
            3. Read CLAUDE.md for general guidelines
            4. Read project-map.md to understand the codebase

            Then implement the requested changes from the issue.

            IMPORTANT:
            - Keep index.html self-contained (single file, no build step)
            - Create a PR with your changes
            - Write a clear PR description explaining what you did and why
            - If you hit an obstacle, document it in the PR description

      # ── Find the PR the agent created ───────────────────────
      - name: Find PR created by agent
        id: find-pr
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sleep 5  # brief wait for PR to register
          PR_DATA=$(gh pr list \
            --state open \
            --author "github-actions[bot]" \
            --limit 1 \
            --json number,title,body \
            2>/dev/null || echo "[]")

          PR_NUMBER=$(echo "$PR_DATA" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d[0]['number'] if d else '')" 2>/dev/null || echo "")
          PR_TITLE=$(echo  "$PR_DATA" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d[0]['title']  if d else '')" 2>/dev/null || echo "")
          PR_BODY=$(echo   "$PR_DATA" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d[0]['body']   if d else '')" 2>/dev/null || echo "")

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "pr_title=$PR_TITLE"   >> $GITHUB_OUTPUT
          # Truncate body to 2000 chars to avoid env var limits
          echo "pr_body=${PR_BODY:0:2000}" >> $GITHUB_OUTPUT

          echo "Found PR: #$PR_NUMBER — $PR_TITLE"

  # ────────────────────────────────────────────────────────────
  # JOB 2: Distiller — extracts skill/lesson after agent run
  # Runs always, whether agent succeeded or failed
  # Commits directly to main (not the PR branch)
  # ────────────────────────────────────────────────────────────
  distiller:
    name: Distill Skill (SkillRL)
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: agent
    if: always()   # always runs — failures are valuable lessons too

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main          # always commit skills to main, not the PR branch
          fetch-depth: 2
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Anthropic SDK
        run: pip install anthropic --quiet

      - name: Run distiller
        id: distill
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          TASK_TITLE:        ${{ github.event.issue.title }}
          TASK_DESCRIPTION:  ${{ github.event.issue.body }}
          TASK_LABELS:       ${{ join(github.event.issue.labels.*.name, ',') }}
          TASK_OUTCOME:      ${{ needs.agent.outputs.outcome }}
          PR_NUMBER:         ${{ needs.agent.outputs.pr_number }}
          PR_TITLE:          ${{ needs.agent.outputs.pr_title }}
          PR_BODY:           ${{ needs.agent.outputs.pr_body }}
        run: |
          python3 .github/scripts/distill.py

      - name: Commit skills to main
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name  "flywheel-distiller[bot]"
          git config user.email "flywheel-distiller@users.noreply.github.com"

          git add .claude/skills/ lessons.md .claude/skillbank-index.md 2>/dev/null || true

          # Only commit if there are actual changes
          if git diff --staged --quiet; then
            echo "No skill changes to commit."
          else
            OUTCOME="${{ needs.agent.outputs.outcome }}"
            ISSUE_TITLE="${{ github.event.issue.title }}"
            git commit -m "distill($OUTCOME): ${ISSUE_TITLE:0:60}"
            git push origin main
            echo "✅ Skills committed to main"
          fi
