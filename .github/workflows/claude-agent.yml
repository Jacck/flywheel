name: Claude Code Agent

on:
  issue_comment:
    types: [created]
  issues:
    types: [opened, labeled]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

concurrency:
  group: claude-agent
  cancel-in-progress: false

jobs:
  claude:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          label_trigger: "agent-task"
          claude_args: "--max-turns 10"
          settings: |
            {
              "permissions": {
                "allow": [
                  "Bash(gh issue view:*)",
                  "Bash(gh issue list:*)",
                  "Bash(gh pr create:*)",
                  "Bash(gh pr view:*)",
                  "Bash(git add:*)",
                  "Bash(git checkout:*)",
                  "Bash(git commit:*)",
                  "Bash(git push:*)",
                  "Bash(git branch:*)",
                  "Bash(git diff:*)",
                  "Bash(git log:*)",
                  "Bash(git status)",
                  "Read",
                  "Write",
                  "Edit",
                  "MultiEdit",
                  "Glob",
                  "Grep",
                  "TodoRead",
                  "TodoWrite"
                ]
              }
            }
          prompt: |
            You are the Flywheel autonomous coding agent.

            ## Mandatory first steps — always follow this order:
            1. Read the triggering issue: use `gh issue view <number> --json title,body`
            2. Read project-map.md ENTIRELY — this is your compressed understanding of the codebase
            3. Read ONLY the relevant code sections mentioned in project-map.md that match the task
            4. If you need more context, ask yourself "which 50-200 line region do I need?" and read only that range
            5. Never read the full index.html unless the change touches >40% of the file

            ## Implementation rules:
            - Implement the requested changes — do NOT just review or audit the codebase
            - Follow the guidelines in CLAUDE.md
            - Keep index.html self-contained (single file, no build step)
            - Commit to a new branch with a conventional commit message
            - Create a PR referencing the issue number
            - After making changes, update project-map.md line ranges if they shifted significantly

            ## Efficiency rules:
            - Solve the task in as few tool calls as possible
            - Plan first, then execute — avoid exploratory loops
            - If the issue provides line numbers, go directly to those lines
